# regnskapsregister-API

Key values from annual accounts for the last accounting year as open data.

# Local development

## Install java, git, maven and postgres

##### Linux
```
sudo apt update
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install default-jdk git maven postgresql
```

##### Windows
Git for Windows - https://gitforwindows.org/

Apache Maven - https://maven.apache.org/download.cgi

PostgreSQL - https://www.postgresql.org/download/windows/


## Environment variables
These are needed for RREG-API integration:
```
RRAPI_POSTGRES_DB_URL="jdbc:postgresql://localhost:5432/postgres?currentSchema=rregapi&sslmode=prefer"
RRAPI_POSTGRES_DBO_USER="postgres" (whatever you used in your locally installed Postgresql)
RRAPI_POSTGRES_DBO_PASSWORD="password" (whatever you used in your locally installed Postgresql)
RRAPI_POSTGRES_USER="postgres" (whatever you used in your locally installed Postgresql)
RRAPI_POSTGRES_PASSWORD="password" (whatever you used in your locally installed Postgresql)
RRAPI_SFTP_SERVER="filporten.brreg.no"
RRAPI_SFTP_PORT="22"
RRAPI_SFTP_USER="RRmasse"
RRAPI_SFTP_PASSWORD="<password>"
RRAPI_SFTP_DIRECTORY="/out"
RRAPI_SLACK_CHANNEL="prod-error"
RRAPI_SLACK_TOKEN="disabled"
RRAPI_IP_SALT="salt"
```

In addition, you can add this to the application.properties file:
regnskap.fileimport.directory=C:/src/regnskapsregister-api/ (or wherever you might have RREG masse.xml-files)


##### Linux
Open ~/.bashrc and add the lines
```
export RRAPI_POSTGRES_DB_URL="jdbc:postgresql://localhost:5432/postgres?currentSchema=rregapi&sslmode=prefer"
export RRAPI_POSTGRES_DBO_USER="postgres" (whatever you used in your locally installed Postgresql)
...
```
Update from ~/.bashrc with
```
source ~/.bashrc
```

Check that they have been added with "printenv"

##### Windows
“Advanced system settings” → “Environment Variables”


## Clone and run
```
git clone {repo}
mvn clean install
(run or debug Application.main)
```
Liquibase will create database schema "rregapi" and the database itself at startup. If you have set the correct SFTP username and password, or have set a local file import directory, RREG masse.xml-files will be downloaded and imported.   

## Test that everything is running
"/src/main/resources/specification/examples/RegnskapsAPI.postman_collection.json"

Import this collection in Postman to test the api locally.

# Build and deploy on Openshift
For deployment to Brønnøysundregistrene's Openshift environment, Jenkins with standard Brønnøysundregistrene pipeline is used.
https://jenkins-data.apps.ocp-svc.base.brreg.no/job/regnskapsregister-api/

Builds on the main branch are deployed.
Configuration of Openshift environments is found in the appconfig repository:
https://jenkins-data.apps.ocp-svc.base.brreg.no/job/regnskapsregister-api/

# Exporting importfiles

Importfiles are generated by Regnskapsregisteret and uploaded to SFTP-server with a name-format "yyyyMMddHHmmss-masse.xml". These files are downloaded and imported by regnskapsregister-api UpdateService daily.
When importing a file, the filename and a zipped version of the file is stored in rregapi.regnskaplog, and all Regnskap in that file is parsed and stored in rregapi.regnskap, together with a foreign key relation to the rregapi.regnskaplog entry.
Sometimes (for testing/debugging?), you might want to fetch the import-file for a given date (postgres will only support exporting a single row at a time. If you want more files, make a wrapper script)
 
## From internal Brreg Postgres
Use a tool like pgAdmin og DataGrip to connect to the appropriate Postgres instance (ST or PPE). Connection info is found in the appconfig repository (https://bitbucket.brreg.no/projects/OPENSHIFT-APPCONFIG/repos/regnskap/browse)

In a pgAdmin SQL view, run (example for 31.dec 2018) the query "SELECT ENCODE(zipfile, 'base64') FROM rregapi.regnskaplog WHERE filename LIKE '20181231%' LIMIT 1;", use File|Export, use "No Quoting" and uncheck "Column Names", and export to a file. (using psql, you can use "\copy" for the SELECT statement to export to file)  

In a shell, execute "base64 --decode <exported_file> > file.zip"  

Unzip this file to get the original masse.xml-file

# Useful links
[RREG-API GitHub repository](https://github.com/brreg/regnskapsregister-api/)

[RREG-API Helm Chart](https://github.com/brreg/helm-chart/tree/main/helm-chart-sources/regnskapsregister-api)

## UT1

[RREG-API GCP deployment details](https://console.cloud.google.com/kubernetes/deployment/europe-north1-a/rreg-dev/ut1/regnskapsregister-api/overview)

[RREG-API Endpoint](http://rreg.ut1.rreg-dev.brreg.no/regnskap)

[RREG-API Swagger UI](http://rreg.ut1.rreg-dev.brreg.no/swagger-ui/index.html?configUrl=/v3/api-docs/swagger-config)

## Prod

[RREG-API PROD GCP deployment details](https://console.cloud.google.com/kubernetes/deployment/europe-north1-a/rreg-prod/prod/regnskapsregister-api/overview)

[RREG-API Endpoint](http://34.98.91.231/regnskap)
